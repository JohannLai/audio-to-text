name: Opened or edited issue
on:
  issues:
    types: [opened, edited]

jobs:
  audio-to-text:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          repository: johannlai/audio-to-text
          token: ${{ secrets.ACTIONS_SECRET }}
      - name: View issue information
        run: |
          echo "Issue title: ${{ github.event.issue.title }}"
          echo "Issue body: ${{ github.event.issue.body }}"
          echo "${{ github.event.issue.title }} ${{ github.event.issue.body }}" > issue.txt
      - uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const issueOutput = fs.readFileSync('issue.txt', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              Hi there! üëã

              Thanks for using my services! ü§ñ‚ù§Ô∏è! ü§ñ I've received your request and I'm currently working on it.

              I'll be processing the following text:
              \`\`\`shell
              ${issueOutput}
              \`\`\`

              ‚öôÔ∏è It might take a few minutes, so please bear with me. üôè You can check the progress [here](https://github.com/JohannLai/audio-to-text/actions/workflows/issue.yml)

              In the meantime, feel free to grab a cup of coffee ‚òïÔ∏è or take a quick break.

              I'll notify you as soon as I'm done! üòä

              If you find my services helpful, you can support me by buying me a coffee ‚òïÔ∏è using the following button:

              [!["Buy Me A Coffee"](https://www.buymeacoffee.com/assets/img/custom_images/orange_img.png)](https://www.buymeacoffee.com/johannli)
              `
            })
      - name: start audio-to-text
        env:
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          make start_from_issue
      - name: if run failed, comment to issue
        if: ${{ failure() }}
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              Hi there! üëã

              I'm sorry to inform you that I've encountered an error while processing your request. üò¢

              Please try again later by reopen this issue. üôè

              Thanks for using my services! ü§ñ‚ù§Ô∏è
              `
            })
      - name: if run success, comment to issue
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              Hi there! üëã

              I've finished processing your request! ü§ñ

              Here's the result:
              `
            })
      - uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const __dirname = path.resolve();
            const files = fs.readdirSync(path.join(__dirname, 'text_formatted'));

            files.map(file => {
                  let content = fs.readFileSync(path.join(__dirname, 'text_formatted', file), 'utf8');
                  github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: content
                })
            })
      - name: end with coffee
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              üëã

              If you find my services helpful, you can support me by buying me a coffee ‚òïÔ∏è using the following button:

              [!["Buy Me A Coffee"](https://www.buymeacoffee.com/assets/img/custom_images/orange_img.png)](https://www.buymeacoffee.com/johannli)

              Thanks for using my services! ü§ñ‚ù§Ô∏è
              `
            })
